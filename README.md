# Shared functions for discrepancy analysis

This repository contains files used for predicting model discrepancy using linear regression methods. This project is built on the work of [Beattie et al](https://physoc.onlinelibrary.wiley.com/doi/abs/10.1113/JP275733), whose repository is available [here](https://github.com/mirams/sine-wave). To use this code you will need to add the [SharedFunctions repository](https://github.com/JohnWalmsley/SharedFunctions) and its sub-folders to your Matlab path. This repository also requires two functions from the Mathworks File Exchange to be on the Matlab path, [export_fig.m]() and [getLinearIndependent.m]().

Many of these files use a variable called `conf`. `conf` is a cell that specifies which predictors should be used when constructing a linear model of discrepancy. The full options for `conf` are as follows:
<a name="conf"/>
`conf = { 'const', 'variables', 'I', 'rates', 'fluxes', 'sensitivity', 'dIdp', 'voltage', 'dVdt', 'time', 'normalise', 'thin' };`

The order of the entries does not matter. Including a predictor in `conf` means that it will be availbale during model construction. In practice, this is sometimes used to remove the sensitivities from the fit. There are two other options, namely `'normalise'` (normalises variables between -1 and 1, done automatically by most Matlab regression functions) and `'thin'`, which will only include every tenth time point in the data used to build the model.

## Code

#### Subroutines

[BuildDataMatrix.m](Code/BuildDataMatrix.m): Constructs a data matrix for use in linear regression. Takes the following as input:
1. `conf`
1. `variables`
1. `I`
1. `rates`
1. `fluxes`
1. `sensitivity`
1. `dIdp` 
1. `voltage` 
1. `dVdt`
1. `time`
1. a matrix of scaling factors `input_factors` (2xN matrix) (optional)

Outputs:

1. A matrix for regression `mx` (matrix)
1. Scaling factors `factors` (2xN matrix)
1. Names of the linearly independent predictors in the matrix `names` (cell)
 
Inputs 2-10 are generated by [CalculateVariables.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/CalculateVariables.m). `input_factors` allows the scaling factors used when constructing a previous data matrix to be used instead. The function removes any linearly dependent terms from each of the inputs 2-9 in turn. If `conf` contains `'normalise'` then the matrix is normalised, either to between 0 and 1, or using the factors in `input_factors`. The scaling factors used are output into `factors`. Linearly independent entries in `conf` are then included into `mx`, and their names are included into `names`. 

[LinearModelOfDiscrepancyWithInput.m](Code/LinearModelOfDiscrepancyWithInput.m): Constructs a linear model to predict discrepancy. Takes the following as input:
1. A method `method` (string)
2. `conf`
3. The discrepancy to be predicted `discrepancy` (vector)
4. a data matrix produced by [BuildDataMatrix.m](Code/BuildDataMatrix.m) `data_matrix` (matrix)
5. variable names in the matrix `varnames` (cell) (optional)
Outputs:
1. discrepancy (potentially of a different length to the input if `'thin'` is in `conf`) `discrepancy` (vector)
1. data matrix (as above) `data_matrix` (matrix)
1. the constructed linear model `model` (vector or `LinearModel`)
1. a handle to any figures plotted by the method (figHandle)

If `thin` is in conf, the code will only include one in ten of the data points. The following methods can be used: `'least-squares'` solves model = mx \ discrepancy, `'regress'`, `'stepwisefit'`, `'lasso'`, and `'stepwiselm'`. At present, the options for these methods are all hardcoded - this could be improved by adding some sort of `model_conf` structure to the code. Some methods either have to include a constant, or have to not include a constant, in the data matrix - these cases are handled. 

__IMPORTANT__: When using `'lasso'`, K-fold cross validation works much more effectively in this context when the folds are not generated randomly. To prevent this, a slight modification of the Matlab source code (use `sudo` or similar) is required: `../MATLAB/R2017a/toolbox/stats/stats/+internal/+stats/cvpartitionImpl.m` must be edited so that `SetAccess` for `indices` is no longer `protected`, but instead is `public`. My `cvpartitionImpl.m` looks like this at line 113:
```
properties(GetAccess = public, SetAccess = public)
        indices = [];
        Group = [];
        holdoutT = [];
end
```

#### Performing Linear Regression

[PredictDiscrepancyUsingLinearModel.m](Code/PredictDiscrepancyUsingLinearModel.m): Uses a regression method to construct a linear model of the discrepancy between a cell simulation and experimental data. Inputs:
1. Cell identifier `exp_ref` (string)
1. Training protocol `training_protocol` (string)
1. Prediction protocol `prediction_protocol` (string)
1. Method `method` (string)
1. Identifier for how much of the trace to use `only_core = 0` (logical)(optional)
1. Fitting protocol used to parameterise the ODE model `fitting_protocol = {'sine_wave'}` (cell or string) (optional)
1. `conf`

Options for the `method` are the same as for [LinearModelOfDiscrepancyWithInput.m](#LinearModelOfDiscrepancyWithInput). The code calculates the variables for the data used to train the model using [CalculateVariables.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/CalculateVariables.m), and the discrepancy between the model and the experiment for that protocol (defined as simulated current - recorded current) using [CalculateDiscrepancy.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/CalculateVariables.m). Indices are then removed to avoid the capacitative spikes and (if `only_core=1`) the activation and deactivation steps at the start and finish of the protocol using [GetNoSpikeIdx.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/GetNoSpikeIdx.m) and [GetCoreOfProtocolIdx.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/GetCoreOfProtocolIdx.m). The data matrix is then built from the variables produced by [CalculateDiscrepancy.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/CalculateVariables.m) using [BuildDataMatrix.m](Code/BuildDataMatrix.m). A second test for linear independence is performed on the data matrix which throws a warning in case two of the different sorts of variables included are linearly dependent, which should not happen. The model is then constructed using [LinearModelOfDiscrepancyWithInput.m](Code/LinearModelOfDiscrepancyWithInput.m). This process is repeated for the discrepancy in the open probability, creating a second model.

Prediction is then performed by calculating the variables for `'prediction_protocol'` using [CalculateVariables.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/CalculateVariables.m) and then building the data matrix with [BuildDataMatrix.m](Code/BuildDataMatrix.m) using the factors from the first step to ensure normalisation is consistent between the two matrices. Prediction of discrepancy is then performed using the models on this data matrix. 

The code will then plot the currents with the predicted discrepancy, the predicted discrepancy, the coefficients and predictors included in the models, and, if `'method'=='lasso'`, a cross-validation plot showing the selected models and the regularization parameter.

#### Testing Linear Regression

[BatchTestPredictDiscrepancyUsingLinearModel.m](Code/BatchTestPredictDiscrepancyUsingLinearModel.m): Code used for testing the effectiveness of regresision techniques. Takes the following as input:
1. A cell identifier `exp_ref` (string)
1. A training protocol `training_protocol` (string or cell)
1. number of repeats `num_repeats=10` (integer) (optional)
1. noise `noise=1` (logical) (optional)
1. [conf](#conf) (optional)

This file constructs `num_repeats` discrepancy models at random from the variables in `conf` produced from simulations of cell `exp_ref` fitted using `training_protocol`. A random number of variables from 1-20 are included in each model. Both LASSO and StepwiseLM are used to construct models using [BuildDataMatrix.m](Code/BuildDataMatrix.m) and [LinearModelOfDiscrepancyWithInput.m](Code/LinearModelOfDiscrepancyWithInput.m). The MSE between the coefficients of the original constructed model and the model derived by regression is used to quantify the quality of the fit. A plot is then produced showing the relationship between number of predictors in the original model and quality of fit for both regression methods.

[TestPredictDiscrepancyUsingLinearModel.m](Code/TestPredictDiscrepancyUsingLinearModel.m): Code used for testing the effectiveness of regression techniques. Takes the following as input:
1. A cell identifier `exp_ref` (string)
1. A training protocol `training_protocol` (string or cell)
1. method `method` (string)
1. variable indices `test_idx` (integer vector) (optional)
1. [conf](#conf) (optional)

This file constructs one discrepancy model from the variables in `conf` produced from simulations of cell `exp_ref` fitted using `training_protocol`. The included variables can either be specified using `test_idx`, or generated if not specified. If generated, a random number of variables from 1-20 are included in the model. The `method` is used to construct models using [BuildDataMatrix.m](Code/BuildDataMatrix.m) and [LinearModelOfDiscrepancyWithInput.m](Code/LinearModelOfDiscrepancyWithInput.m). Two plots are produced, one showing the fit of the the model derived by regression to the original constructed model, and one showing the coefficients of both models.

#### Plotting

[PlotDiscrepancyVsDiscrepancyInOpen.m](Code/PlotDiscrepancyVsDiscrepancyInOpen.m): Input:
1. Cell identifier `exp_ref` (string)
1. Fitting protocols `fitting_protocols` (cell)
1. Prediction protocols `fitting_protocols` (cell)

This file plots the discrepancy and the discrepancy in open probability for the protocols used to fit the model (top row) and the protocols being predicted (bottom row). Saves into a folder called `'Figures/'`.

[PlotSensitivityVsDiscrepancy.m](Code/PlotSensitivityVsDiscrepancy.m): Creates plots of parameter sensitivity vs discrepancy for all 3 variables and 8 parameters in the HH model.

[PlotDiscrepancyVsDiscrepancyInOpen.m](Code/PlotDiscrepancyVsDiscrepancyInOpen.m): Input:
1. Cell identifier `exp_ref` (string)
1. Fitting protocols `fitting_protocols` (cell)
1. Prediction protocols `fitting_protocols` (cell)

This file plots the simulation and the experimental data together, and then the discrepancy between the two for the protocols used to fit the model (top row) and the protocols being predicted (bottom row). Saves into a folder called `'Figures/'`.

[PlotSimulationProtocols.m](Code/PlotSimulationProtocols.m): This script plots the voltage protocols and the currents generated used in this project (`'sine_wave'`,`'ap'`,`'original_sine'`, `'equal_proportions'`, `'maz_wang_div_diff'`). The 'core' of the protocol as used in [PredictDiscrepancyUsingLinearModel.m](Code/PredictDiscrepancyUsingLinearModel.m) is highlighted in red.

[PlotVoltageTraces.m](Code/PlotVoltageTraces.m): Input:
1. Fitting protocols `fitting_protocols` (cell)
1. Prediction protocols `fitting_protocols` (cell)

Plots a selection of voltage traces.

### Old Code

[CompareEffectsOfLag.m](https://github.com/JohnWalmsley/DiscrepancyCorrelations/blob/master/Code/Old%20Code/CompareEffectsOfLag.m) Shows the minor difference that the effect of a delay in the amplifier reaching the desired membrane potential will have. Uses the `ap_lag` protocol generated using [CalculateImposedVoltage.m](CalculateImposedVoltage.m)

[CompareParameterFits.m](https://github.com/JohnWalmsley/DiscrepancyCorrelations/blob/master/Code/Old%20Code/CompareParameterFits.m): Compares fits to the sine wave only, fits to the AP only, and a fit to both protocols at the same time in terms of the currents generated.

[CompareParameterFits_SummaryPlots.m](https://github.com/JohnWalmsley/DiscrepancyCorrelations/blob/master/Code/Old%20Code/CompareParameterFits_SummaryPlots.m): Compares fits to the sine wave only, fits to the AP only, and a fit to both protocols at the same time in terms of summary plots such as an I-V curve and the activation, deactivation, and inactivation protocols.

[DiscrepancyInOpenProbability.m](https://github.com/JohnWalmsley/DiscrepancyCorrelations/blob/master/Code/Old%20Code/DiscrepancyInOpenProbability.m): Replaced by [PredictDiscrepancyUsingLinearModel.m](Code/PredictDiscrepancyUsingLinearModel.m)

[LinearModelOfDiscrepancy.m](https://github.com/JohnWalmsley/DiscrepancyCorrelations/blob/master/Code/Old%20Code/LinearModelOfDiscrepancy.m): Replaced by [LinearModelOfDiscrepancyWithInput.m](Code/LinearModelOfDiscrepancyWithInput.m)

[PredictDiscrepancy.m](https://github.com/JohnWalmsley/DiscrepancyCorrelations/blob/master/Code/Old%20Code/PredictDiscrepancy.m):Replaced by [PredictDiscrepancyUsingLinearModel.m](Code/PredictDiscrepancyUsingLinearModel.m)

## ExperimentalData

[ExperimentalData](ExperimentalData/): Contains the experimental data used by [Beattie et al](https://physoc.onlinelibrary.wiley.com/doi/abs/10.1113/JP275733) and available in the [sine-wave repository](https://github.com/mirams/sine-wave). Also includes the averaged experimental data. Includes additional processed files from [Kylie-Sine-Wave-Data](https://github.com/JohnWalmsley/Kylie-Sine-Wave-Data).

## MCMCREsults

[MCMCResults](MCMCResults/): Contains MCMC chains and likelihoods produced using either [sine-wave](https://github.com/mirams/sine-wave) or [FittingAlgorithm](https://github.com/JohnWalmsley/FittingAlgorithm).

## ParameterSets

Baseline model parameter sets. Rarely used in this study except by [modeldata.m](https://github.com/JohnWalmsley/SharedFunctions/blob/master/modeldata.m)

## Protocols

[Protocols](Protocols/): Contains a .mat file for each pacing protocol.
